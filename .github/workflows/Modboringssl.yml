name: Build mod optimise v6

on:
  workflow_dispatch:
    inputs:
      release_tag:
        required: false
        type: string
      merge_prs:
        description: 'Comma-separated PR numbers to merge (e.g., "1,2,3" or "0" for none)'
        required: false
        default: ''
        type: string
        
      fetch_branches_from_other:
        description: 'Enter "username/repo branch" to fetch & merge, or 0 for none'
        required: false
        default: '0'
      merge_dns:
        description: 'merge DNS commit (0 = none)'
        required: false
        default: '0'
        
 
jobs:
  build:
    runs-on: ubuntu-latest
    steps:

    - name: Checkout repository
      uses: actions/checkout@v6.0.0
      with:
        submodules: false
      
    - name: Set Swap Space
      uses: pierotofy/set-swap-space@master
      with:
          swap-size-gb: 10
    
    - name: Set up Go
      uses: actions/setup-go@v6
      with:
          go-version: '1.26.0-rc.3'
          check-latest: true

    - name: Activate patched Go
      shell: bash
      run: |
       go version
       
    - name: Install gomobile
      run: |
        go install golang.org/x/mobile/cmd/gomobile@latest
        
    - name: Setup Android SDK
      uses: android-actions/setup-android@v3.2.0
      with:
        log-accepted-android-sdk-licenses: false
        cmdline-tools-version: '12266719'
        packages: 'platforms;android-35 build-tools;35.0.0 platform-tools'

    - name: Install NDK
      run: |
        echo "y" | $ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager \
          --channel=0 \
          --install "ndk;28.2.13676358"
        echo "ANDROID_NDK_HOME=$ANDROID_HOME/ndk/28.2.13676358" >> $GITHUB_ENV

    - name: Setup BoringSSL Source
      run: |
        echo "üîß Setting up BoringSSL for local development..."
        
        BORINGSSL_DIR="app/src/main/jni/perf-net/third_party/boringssl"
        
        if [ -d "$BORINGSSL_DIR" ] && [ -f "$BORINGSSL_DIR/CMakeLists.txt" ]; then
            echo "‚úÖ BoringSSL source already exists at $BORINGSSL_DIR"
            if [ -f "$BORINGSSL_DIR/include/openssl/ssl.h" ]; then
                echo "‚úÖ BoringSSL headers verified"
                cd "$BORINGSSL_DIR"
                COMMIT=$(git rev-parse HEAD | cut -c 1-12)
                echo "üìå BoringSSL commit: $COMMIT"
                cd - > /dev/null
                exit 0
            fi
        fi
        
        echo "üì¶ Initializing BoringSSL submodule..."
        
        if ! git config -f .gitmodules --get submodule.app/src/main/jni/perf-net/third_party/boringssl.url > /dev/null 2>&1; then
            echo "‚ö†Ô∏è  BoringSSL submodule not found in .gitmodules"
            if [ -d "$BORINGSSL_DIR" ]; then
                rm -rf "$BORINGSSL_DIR"
            fi
            git submodule add --force https://boringssl.googlesource.com/boringssl "$BORINGSSL_DIR" || {
                echo "‚ö†Ô∏è  Failed to add from googlesource, trying GitHub mirror..."
                git submodule add --force https://github.com/google/boringssl.git "$BORINGSSL_DIR" || {
                    echo "‚ùå Failed to add BoringSSL submodule"
                    exit 1
                }
            }
        fi
        
        if git submodule update --init --depth 1 "$BORINGSSL_DIR" 2>&1; then
            echo "‚úÖ BoringSSL submodule initialized successfully"
        else
            if git submodule update --init "$BORINGSSL_DIR" 2>&1; then
                echo "‚úÖ BoringSSL submodule initialized successfully"
            else
                echo "‚ùå Failed to initialize BoringSSL submodule"
                exit 1
            fi
        fi
        
        if [ ! -f "$BORINGSSL_DIR/CMakeLists.txt" ]; then
            echo "‚ùå BoringSSL CMakeLists.txt not found!"
            exit 1
        fi
        
        if [ ! -f "$BORINGSSL_DIR/include/openssl/ssl.h" ]; then
            echo "‚ùå BoringSSL headers not found!"
            exit 1
        fi
        
        cd "$BORINGSSL_DIR"
        COMMIT=$(git rev-parse HEAD | cut -c 1-12)
        echo "‚úÖ BoringSSL pinned to commit: $COMMIT"
        cd - > /dev/null
        
        echo ""
        echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
        echo "‚úÖ BoringSSL Setup Complete!"
        echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"

    - name: Build BoringSSL
      run: |
        echo "üîß Building BoringSSL for arm64-v8a..."
        
        ABI="arm64-v8a"
        NDK_HOME="$ANDROID_NDK_HOME"
        TOOLCHAIN="aarch64-linux-android24"
        CMAKE_ARCH="arm64-v8a"
        
        echo "NDK: $NDK_HOME"
        echo "Toolchain: $TOOLCHAIN"
        
        BORINGSSL_DIR="app/src/main/jni/perf-net/third_party/boringssl"
        if [ ! -d "$BORINGSSL_DIR" ]; then
            echo "‚ùå BoringSSL directory not found: $BORINGSSL_DIR"
            exit 1
        fi
        
        cd "$BORINGSSL_DIR"
        
        TOOLCHAIN_DIR="$NDK_HOME/toolchains/llvm/prebuilt/linux-x86_64"
        export PATH=$TOOLCHAIN_DIR/bin:$PATH
        export CC=$TOOLCHAIN_DIR/bin/$TOOLCHAIN-clang
        export CXX=$TOOLCHAIN_DIR/bin/$TOOLCHAIN-clang++
        export AR=$TOOLCHAIN_DIR/bin/llvm-ar
        export RANLIB=$TOOLCHAIN_DIR/bin/llvm-ranlib
        export STRIP=$TOOLCHAIN_DIR/bin/llvm-strip
        export ANDROID_NDK_HOME=$NDK_HOME
        export ANDROID_NDK_ROOT=$NDK_HOME
        
        BUILD_DIR="build_$ABI"
        mkdir -p "$BUILD_DIR"
        cd "$BUILD_DIR"
        
        echo "üì¶ Current directory: $(pwd)"
        
        cmake .. \
            -DCMAKE_SYSTEM_NAME=Android \
            -DCMAKE_SYSTEM_VERSION=24 \
            -DCMAKE_ANDROID_ARCH_ABI=$CMAKE_ARCH \
            -DCMAKE_ANDROID_NDK=$NDK_HOME \
            -DCMAKE_TOOLCHAIN_FILE=$NDK_HOME/build/cmake/android.toolchain.cmake \
            -DCMAKE_BUILD_TYPE=Release \
            -DOPENSSL_SMALL=1 \
            -DOPENSSL_NO_DEPRECATED=1 \
            -DOPENSSL_NO_ASM=0 \
            -DBUILD_SHARED_LIBS=OFF \
            -DBENCHMARK_ENABLE_TESTING=OFF \
            -DBENCHMARK_ENABLE_INSTALL=OFF \
            -DBENCHMARK_ENABLE_GTEST_TESTS=OFF \
            -GNinja 2>&1 | tee cmake.log
        
        CMAKE_EXIT=${PIPESTATUS[0]}
        if [ $CMAKE_EXIT -ne 0 ]; then
            echo "‚ùå CMake configuration failed with exit code $CMAKE_EXIT"
            exit 1
        fi
        
        ninja -v crypto ssl 2>&1 | tee ninja.log
        
        NINJA_EXIT=${PIPESTATUS[0]}
        if [ $NINJA_EXIT -ne 0 ]; then
            echo "‚ùå Ninja build failed with exit code $NINJA_EXIT"
            tail -50 ninja.log
            exit 1
        fi
        
        echo "üìÇ Build directory contents:"
        ls -la
        echo "üìÇ Searching for all .a files:"
        find . -name "*.a" -type f 2>/dev/null || echo "No .a files found"
        
        CRYPTO_LIB=""
        SSL_LIB=""
        
        if [ -f "crypto/libcrypto.a" ]; then
            CRYPTO_LIB="$(pwd)/crypto/libcrypto.a"
        elif [ -f "libcrypto.a" ]; then
            CRYPTO_LIB="$(pwd)/libcrypto.a"
        else
            CRYPTO_LIB=$(find . -name "libcrypto.a" -type f | head -1)
        fi
        
        if [ -f "ssl/libssl.a" ]; then
            SSL_LIB="$(pwd)/ssl/libssl.a"
        elif [ -f "libssl.a" ]; then
            SSL_LIB="$(pwd)/libssl.a"
        else
            SSL_LIB=$(find . -name "libssl.a" -type f | head -1)
        fi
        
        if [ -z "$CRYPTO_LIB" ] || [ -z "$SSL_LIB" ]; then
            echo "‚ùå Build failed - libraries not found"
            find . -type f -name "*.a" -o -name "libcrypto*" -o -name "libssl*" 2>/dev/null | head -20
            exit 1
        fi
        
        echo "‚úÖ BoringSSL build complete for $ABI"
        ls -lh "$CRYPTO_LIB" "$SSL_LIB"
        
        echo "BORINGSSL_CRYPTO=$(realpath "$CRYPTO_LIB")" >> $GITHUB_ENV
        echo "BORINGSSL_SSL=$(realpath "$SSL_LIB")" >> $GITHUB_ENV
        echo "BORINGSSL_INCLUDE=$(realpath ../include)" >> $GITHUB_ENV
        
        cd ${{ github.workspace }}

    - name: Download xray-patches
      run: |
        echo "üì• Downloading xray-patches for BoringSSL integration..."
        mkdir -p xray-patches
        
        PATCHES=$(curl -s "https://api.github.com/repos/halibiram/SimpleXray/contents/xray-patches" | grep -o '"name": "[^"]*\.patch"' | cut -d'"' -f4)
        
        for patch in $PATCHES; do
          echo "Downloading: $patch"
          curl -sL "https://raw.githubusercontent.com/halibiram/SimpleXray/main/xray-patches/$patch" -o "xray-patches/$patch"
        done
        
        echo "üìÇ Available patches:"
        ls -la xray-patches/
    - name: Fix handshake trace patch
      run: |
        echo "üîß Fixing 007-boringssl-handshake-trace.patch for current Xray-core..."
        
        PATCH_FILE="xray-patches/007-boringssl-handshake-trace.patch"
        
        # Delete old patch if exists
        rm -f "$PATCH_FILE"
        
        

    - name: Prepare Xray-core
      run: |
        mkdir -p assets data
        bash gen_assets.sh download
        cp -v data/*.dat assets/
        echo "Preparing Go environment..."
        go env -w GOPRIVATE=github.com/xtls/xray-core
        go env -w GONOSUMDB=github.com/xtls/xray-core

        MODCACHE=$(go env GOMODCACHE)
        echo "Module cache path: $MODCACHE"

        MOD_PATH="$MODCACHE/github.com/xtls/xray-core"
        rm -rf "$MOD_PATH"
        XRAY_PATH="$GITHUB_WORKSPACE/_deps/xray-core"
        rm -rf "$XRAY_PATH"
        
        git clone https://github.com/xtls/xray-core.git "$XRAY_PATH"
        cd "$XRAY_PATH"
        
        git checkout main || {
          echo "‚ö†Ô∏è  v25.10.15 not found, trying v25.9.30..."
          git checkout v25.9.30 || {
            echo "‚ö†Ô∏è  Falling back to main branch"
            git checkout main
          }
        }
        
        echo "Using Xray-core version: $(git describe --tags --always 2>/dev/null || git rev-parse --short HEAD)"
        
        git fetch origin main
        LOCAL_SHA=$(git rev-parse HEAD)
        REMOTE_SHA=$(git rev-parse origin/main)

        echo "Local HEAD:   $LOCAL_SHA"
        echo "Origin/main: $REMOTE_SHA"

        if [ "$LOCAL_SHA" = "$REMOTE_SHA" ]; then
         echo "‚úÖ xray-core is up to date with origin/main"
        else
         echo "‚ö†Ô∏è xray-core is NOT at latest origin/main"
        fi
        
        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"

        if [ "${{ github.event.inputs.merge_dns }}" != "0" ]; then
         DNS_MSG="refactor(dns): streamline query handling and remove redundant deadline logic"
         git remote add j2rong4cn https://github.com/j2rong4cn/Xray-core.git
         git fetch j2rong4cn main
         DNS_HOST_SHA=$(git log j2rong4cn/main --grep="$DNS_MSG" --format="%H" -n 1)

         if [ -n "$DNS_HOST_SHA" ]; then
          echo "Found commit: $DNS_HOST_SHA"
          git cherry-pick "$DNS_HOST_SHA" || true
         fi
        fi
       
        IFS=',' read -ra PR_LIST <<< "${{ github.event.inputs.merge_prs }}"
        for PR_NUM in "${PR_LIST[@]}"; do
          if [ "$PR_NUM" != "0" ] && [ -n "$PR_NUM" ]; then
            echo "Fetching PR #$PR_NUM..."
            git fetch origin pull/$PR_NUM/head:pr-$PR_NUM
            echo "Merging PR #$PR_NUM..."
            git merge -X theirs --no-edit pr-$PR_NUM || true
          fi
        done

        if [ "${{ github.event.inputs.fetch_branches_from_other }}" != "0" ]; then
          BRANCH_INPUT="${{ github.event.inputs.fetch_branches_from_other }}"
          IFS=',' read -ra EXT_LIST <<< "$BRANCH_INPUT"
          for ITEM in "${EXT_LIST[@]}"; do
            REPO=$(echo "$ITEM" | awk '{print $1}')
            BRANCH=$(echo "$ITEM" | awk '{print $2}')
            echo "Fetching branch '$BRANCH' from repo '$REPO'..."
            REMOTE_NAME="ext_$(echo "$REPO" | sed 's|/|_|g')"
            git remote add "$REMOTE_NAME" "https://github.com/$REPO.git" || true
            git fetch "$REMOTE_NAME" "$BRANCH"
            git merge -X theirs --no-edit "$REMOTE_NAME/$BRANCH" || true
          done
        fi
        
        wget https://raw.githubusercontent.com/t-e-s-tweb/v-rules/refs/heads/main/xmuxpatch.sh
        bash xmuxpatch.sh
        
        cd ${{ github.workspace }}

        echo "Updating go.mod to use local xray-core..."
        go mod edit -replace=github.com/xtls/xray-core="$XRAY_PATH"

    - name: Apply Patches (Required)
      working-directory: ${{ github.workspace }}/_deps/xray-core
      run: |
        echo "üîß Applying BoringSSL patches (ALL PATCHES REQUIRED)"
        echo "‚ö†Ô∏è  Any patch failure will cause build to fail"

        XRAY_CURRENT_VERSION=$(git describe --tags --exact-match 2>/dev/null || git rev-parse --short HEAD)
        echo "üìå Xray-core version: $XRAY_CURRENT_VERSION"

        if [ ! -d "$GITHUB_WORKSPACE/xray-patches" ]; then
          echo "‚ùå ERROR: xray-patches directory not found!"
          echo "   Patches are required for BoringSSL integration"
          exit 1
        fi

        PATCH_COUNT=0
        SUCCESS_COUNT=0
        SKIP_COUNT=0
        FAILED_COUNT=0
        CRITICAL_PATCHES=()

        for patch in $(ls -1 $GITHUB_WORKSPACE/xray-patches/*.patch 2>/dev/null | sort); do
          if [ ! -f "$patch" ]; then
            continue
          fi
          
          PATCH_COUNT=$((PATCH_COUNT + 1))
          PATCH_NAME=$(basename "$patch")
          
          if ! grep -q "^diff --git\|^---\|^\+\+\+" "$patch" 2>/dev/null; then
            echo "‚ÑπÔ∏è  Skipping $PATCH_NAME (placeholder/documentation only)"
            SKIP_COUNT=$((SKIP_COUNT + 1))
            continue
          fi
          
          echo ""
          echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
          echo "üìù Applying patch: $PATCH_NAME"
          echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
          
          PATCH_VERSION=$(grep -i "xray.*version\|xray.*tag" "$patch" | head -1 || echo "")
          if [ -n "$PATCH_VERSION" ]; then
            echo "   Patch version info: $PATCH_VERSION"
          fi
          
          if ! head -1 "$patch" | grep -q "^diff --git"; then
            echo "‚ùå ERROR: Invalid patch format in $PATCH_NAME"
            echo "   First line: $(head -1 "$patch")"
            CRITICAL_PATCHES+=("$PATCH_NAME (invalid format)")
            FAILED_COUNT=$((FAILED_COUNT + 1))
            continue
          fi
          
          if grep -q "index 0000000\.\.1111111" "$patch"; then
            echo "‚ö†Ô∏è  WARNING: Patch contains placeholder index values"
            echo "   This may indicate an incomplete patch file"
          fi
          
          echo "   Running: git apply --check \"$patch\""
          set +e
          git apply --check "$patch" > /tmp/patch_check_stdout.txt 2> /tmp/patch_check_stderr.txt
          PATCH_CHECK_EXIT=$?
          set -e
          PATCH_CHECK_OUTPUT=$(cat /tmp/patch_check_stdout.txt /tmp/patch_check_stderr.txt 2>/dev/null || echo "")
          echo "   Check exit code: $PATCH_CHECK_EXIT"
          if [ $PATCH_CHECK_EXIT -ne 0 ]; then
            echo "   Error output (stdout):"
            cat /tmp/patch_check_stdout.txt 2>/dev/null | sed 's/^/      /' || echo "      (empty)"
            echo "   Error output (stderr):"
            cat /tmp/patch_check_stderr.txt 2>/dev/null | sed 's/^/      /' || echo "      (empty)"
          fi
          
          if [ $PATCH_CHECK_EXIT -eq 0 ]; then
            echo "   Running: git apply \"$patch\""
            set +e
            PATCH_APPLY_OUTPUT=$(git apply "$patch" 2>&1)
            PATCH_APPLY_EXIT=$?
            set -e
            echo "   Apply exit code: $PATCH_APPLY_EXIT"
            
            if [ $PATCH_APPLY_EXIT -eq 0 ]; then
              echo "‚úÖ Successfully applied: $PATCH_NAME"
              SUCCESS_COUNT=$((SUCCESS_COUNT + 1))
            else
              echo "‚ùå ERROR: Failed to apply $PATCH_NAME"
              echo "   Exit code: $PATCH_APPLY_EXIT"
              echo "   Error output:"
              echo "$PATCH_APPLY_OUTPUT" | sed 's/^/   /'
              
              echo "   Checking if patch is already applied..."
              set +e
              if git apply --reverse --check "$patch" 2>/dev/null; then
                set -e
                echo "   ‚ÑπÔ∏è  Patch appears to be already applied (reversing check passed)"
                SUCCESS_COUNT=$((SUCCESS_COUNT + 1))
              else
                set -e
                echo "   ‚ùå Patch is not already applied"
                
                echo "   Attempting 3-way merge to resolve conflicts..."
                set +e
                PATCH_3WAY_OUTPUT=$(git apply --3way "$patch" 2>&1)
                PATCH_3WAY_EXIT=$?
                set -e
                
                if [ $PATCH_3WAY_EXIT -eq 0 ]; then
                  echo "   ‚úÖ Successfully applied with 3-way merge"
                  SUCCESS_COUNT=$((SUCCESS_COUNT + 1))
                else
                  echo "   ‚ùå 3-way merge also failed"
                  echo "   3-way merge output:"
                  echo "$PATCH_3WAY_OUTPUT" | sed 's/^/      /' || true
                  CRITICAL_PATCHES+=("$PATCH_NAME (apply failed)")
                  FAILED_COUNT=$((FAILED_COUNT + 1))
                fi
              fi
            fi
          else
            echo "‚ùå ERROR: Patch check failed for: $PATCH_NAME"
            echo "   Exit code: $PATCH_CHECK_EXIT"
            echo "   Full error output:"
            echo "$PATCH_CHECK_OUTPUT" | sed 's/^/   /'
            
            if grep -q "^diff --git\|^---\|^\+\+\+" "$patch" 2>/dev/null; then
              echo "   Patch expects to modify:"
              grep -E "^diff --git|^---|^\+\+\+" "$patch" | head -5 | sed 's/^/      /' || true
              
              PATCH_FILES=$(grep "^diff --git" "$patch" | sed 's/^diff --git a\///;s/ b\/.*$//' | head -3)
              echo "   Checking if target files exist:"
              for file in $PATCH_FILES; do
                if [ -f "$file" ]; then
                  echo "      ‚úÖ File exists: $file"
                  echo "      First 5 lines of file:"
                  head -5 "$file" | sed 's/^/         /' || true
                else
                  echo "      ‚ùå File missing: $file"
                  echo "      Searching for similar files:"
                  find . -name "$(basename "$file")" -type f 2>/dev/null | head -3 | sed 's/^/         /' || echo "         (none found)"
                fi
              done
            fi
            
            echo "   ‚ÑπÔ∏è  Attempting various merge strategies for required patch..."
            
            if echo "$PATCH_CHECK_OUTPUT" | grep -q "already exists in working directory"; then
              echo "   ‚ÑπÔ∏è  Some files already exist - checking if patch content is already present..."
              set +e
              if git apply --reverse --check "$patch" 2>/dev/null; then
                set -e
                echo "   ‚úÖ Patch content appears to be already applied"
                SUCCESS_COUNT=$((SUCCESS_COUNT + 1))
              else
                set -e
                echo "   ‚ö†Ô∏è  Files exist but patch not fully applied - attempting 3-way merge..."
                set +e
                PATCH_3WAY_OUTPUT=$(git apply --3way "$patch" 2>&1)
                PATCH_3WAY_EXIT=$?
                set -e
                
                if [ $PATCH_3WAY_EXIT -eq 0 ]; then
                  echo "   ‚úÖ Successfully applied with 3-way merge"
                  SUCCESS_COUNT=$((SUCCESS_COUNT + 1))
                else
                  echo "   ‚ùå 3-way merge failed"
                  echo "   3-way merge output:"
                  echo "$PATCH_3WAY_OUTPUT" | sed 's/^/      /' || true
                  CRITICAL_PATCHES+=("$PATCH_NAME (check failed)")
                  FAILED_COUNT=$((FAILED_COUNT + 1))
                fi
              fi
            else
              echo "   Attempting 3-way merge..."
              set +e
              PATCH_3WAY_OUTPUT=$(git apply --3way "$patch" 2>&1)
              PATCH_3WAY_EXIT=$?
              set -e
              
              if [ $PATCH_3WAY_EXIT -eq 0 ]; then
                echo "   ‚úÖ Successfully applied with 3-way merge"
                SUCCESS_COUNT=$((SUCCESS_COUNT + 1))
              else
                echo "   ‚ùå 3-way merge failed"
                echo "   3-way merge output:"
                echo "$PATCH_3WAY_OUTPUT" | sed 's/^/      /' || true
                CRITICAL_PATCHES+=("$PATCH_NAME (check failed)")
                FAILED_COUNT=$((FAILED_COUNT + 1))
              fi
            fi
          fi
        done

        echo ""
        echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
        echo "üìä Patch Summary"
        echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
        echo "   Total patches: $PATCH_COUNT"
        echo "   ‚úÖ Applied: $SUCCESS_COUNT"
        echo "   ‚è≠Ô∏è  Skipped: $SKIP_COUNT"
        echo "   ‚ùå Failed: $FAILED_COUNT"

        if [ $PATCH_COUNT -eq 0 ]; then
          echo ""
          echo "‚ùå ERROR: No patches found in xray-patches directory!"
          exit 1
        fi

        CRITICAL_PATCH_NAMES=(
          "001-boringssl-bridge.patch"
          "002-crypto-boringssl-cgo.patch"
          "002-crypto-boringssl-nocgo.patch"
          "003-tls-boringssl-cgo.patch"
          "003-tls-boringssl-nocgo.patch"
          "004-x509-boringssl-cgo.patch"
          "004-x509-boringssl-nocgo.patch"
          "005-boringssl-tls-bridge.patch"
          "006-xray-imports-redirect.patch"
          "007-boringssl-handshake-trace.patch"
          "008-boringssl-runtime-detection.patch"
          "009-aes-gcm-implementation.patch"
        )
        CRITICAL_FAILED=()

        for failed_patch in "${CRITICAL_PATCHES[@]}"; do
          for critical_name in "${CRITICAL_PATCH_NAMES[@]}"; do
            if [[ "$failed_patch" == *"$critical_name"* ]]; then
              CRITICAL_FAILED+=("$failed_patch")
              break
            fi
          done
        done

        if [ ${#CRITICAL_FAILED[@]} -gt 0 ]; then
          echo ""
          echo "‚ùå CRITICAL: The following REQUIRED patches failed to apply:"
          for failed_patch in "${CRITICAL_FAILED[@]}"; do
            echo "   - $failed_patch"
          done
          echo ""
          echo "‚ùå ERROR: Critical patch failures detected - build cannot continue"
          echo "   These patches are required for BoringSSL integration"
          echo "   Please fix the patch files and retry"
          
        elif [ ${#CRITICAL_PATCHES[@]} -gt 0 ]; then
          echo ""
          echo "‚ö†Ô∏è  WARNING: Some patches failed but were not in critical list:"
          for failed_patch in "${CRITICAL_PATCHES[@]}"; do
            IS_CRITICAL=false
            for critical_name in "${CRITICAL_PATCH_NAMES[@]}"; do
              if [[ "$failed_patch" == *"$critical_name"* ]]; then
                IS_CRITICAL=true
                break
              fi
            done
            
            if [ "$IS_CRITICAL" = false ]; then
              echo "   - $failed_patch"
            fi
          done
          echo ""
          echo "‚ÑπÔ∏è  All patches are required - build will fail if any critical patch fails"
        fi

        if [ $SUCCESS_COUNT -eq 0 ] && [ $FAILED_COUNT -gt 0 ]; then
          echo ""
          echo "‚ùå ERROR: No patches were successfully applied!"
          echo "   This indicates a serious problem with patch compatibility"
          exit 1
        fi

        if [ $SUCCESS_COUNT -gt 0 ]; then
          echo ""
          echo "‚úÖ Successfully applied $SUCCESS_COUNT patch(es) - BoringSSL integration enabled"
        fi

        echo ""
        echo "üîç Verifying Go syntax after patching..."
        cd ${{ github.workspace }}
        if ! go build -n ./_deps/xray-core/... 2>&1 | head -20; then
          echo "‚ùå Go syntax verification failed!"
          echo "Checking for syntax errors in modified files..."
          
          for file in transport/internet/tls/config.go common/crypto/aes.go; do
            if [ -f "_deps/xray-core/$file" ]; then
              echo "Checking $file..."
              if ! gofmt -e "_deps/xray-core/$file" > /dev/null 2>&1; then
                echo "‚ùå Syntax error in $file"
                echo "Around line 549:"
                sed -n '540,560p' "_deps/xray-core/$file" 2>/dev/null || true
              fi
            fi
          done
          exit 1
        fi
        echo "‚úÖ Go syntax verification passed"
        cd _deps/xray-core

        echo ""
        echo "‚úÖ Patch step complete"

    - name: Build with Gomobile
      run: |
        go get golang.org/x/mobile@latest
        go mod tidy
        go mod download

        echo "Binding for Android..."
        export GOMAXPROCS=$(nproc)
        export CGO_ENABLED=1
        export GOEXPERIMENT="runtimefreegc,sizespecializedmalloc,greenteagc,jsonv2,newinliner,heapminimum512kib"
        
        echo "Initializing gomobile..."
        gomobile init -v
        go mod tidy

        NDK_TOOLCHAIN="$ANDROID_NDK_HOME/toolchains/llvm/prebuilt/linux-x86_64"
        NDK_SYSROOT="$NDK_TOOLCHAIN/sysroot"
        
        if [ -z "$BORINGSSL_CRYPTO" ] || [ -z "$BORINGSSL_SSL" ] || [ -z "$BORINGSSL_INCLUDE" ]; then
          echo "‚ùå BoringSSL environment variables not set!"
          exit 1
        fi
        
        echo "‚úÖ BoringSSL libraries:"
        ls -lh "$BORINGSSL_CRYPTO" "$BORINGSSL_SSL"

        export CC="$NDK_TOOLCHAIN/bin/aarch64-linux-android24-clang"
        export CXX="$NDK_TOOLCHAIN/bin/aarch64-linux-android24-clang++"
        export AR="$NDK_TOOLCHAIN/bin/llvm-ar"
        export RANLIB="$NDK_TOOLCHAIN/bin/llvm-ranlib"
        
        export CGO_CFLAGS="-O3 -fvisibility=hidden -ffunction-sections -fdata-sections -fomit-frame-pointer -I$BORINGSSL_INCLUDE --sysroot=$NDK_SYSROOT"
        export CGO_CXXFLAGS="-O3 -fvisibility=hidden -ffunction-sections -fdata-sections -fomit-frame-pointer -I$BORINGSSL_INCLUDE --sysroot=$NDK_SYSROOT"
        
        export CGO_LDFLAGS="\
          -Wl,-Bstatic \
          -L$(dirname $BORINGSSL_CRYPTO) -L$(dirname $BORINGSSL_SSL) \
          -lcrypto -lssl \
          -Wl,-Bdynamic \
          -L$NDK_SYSROOT/usr/lib/aarch64-linux-android/24 \
          -llog -landroid -lc -lm -ldl \
          --sysroot=$NDK_SYSROOT \
          -Wl,-z,max-page-size=16384 \
          -Wl,-z,common-page-size=16384 \
          -Wl,-z,separate-loadable-segments \
          -Wl,-z,now \
          -Wl,--gc-sections"

        echo "=== BUILD ENV ==="
        echo "GOOS=android"
        echo "GOARCH=arm64"
        echo "CC=$CC"
        echo "CGO_CFLAGS=$CGO_CFLAGS"
        echo "CGO_LDFLAGS=$CGO_LDFLAGS"
        echo "=================="
        
        gomobile bind -v -x -androidapi 24 -trimpath \
          -gcflags="all=-l=4" \
          -ldflags="-s -w -linkmode=external" \
          ./

    - name: Strip native libraries in AAR
      run: |
        AAR_FILE="libv2ray.aar"
        EXTRACT_DIR="aar_extract"
        NDK_STRIP="$ANDROID_NDK_HOME/toolchains/llvm/prebuilt/linux-x86_64/bin/llvm-strip"
    
        if [ ! -f "$AAR_FILE" ]; then
          echo "Error: $AAR_FILE not found!"
          exit 1
        fi
    
        mkdir -p "$EXTRACT_DIR"
        unzip -q "$AAR_FILE" -d "$EXTRACT_DIR"
    
        echo "Stripping native libraries..."
        find "$EXTRACT_DIR" -name "*.so" -type f | while read -r so_file; do
          arch=$(basename "$(dirname "$so_file")")
          echo "  Processing [$arch]: $(basename "$so_file")"
          size_before=$(stat -c%s "$so_file" 2>/dev/null || stat -f%z "$so_file" 2>/dev/null)
          "$NDK_STRIP" --strip-all "$so_file"
          size_after=$(stat -c%s "$so_file" 2>/dev/null || stat -f%z "$so_file" 2>/dev/null)
          saved=$((size_before - size_after))
          echo "    Saved: $saved bytes"
        done
    
        echo "Repackaging AAR..."
        cd "$EXTRACT_DIR"
        zip -r -X -9 "../${AAR_FILE}.tmp" .
        cd ..
        mv "${AAR_FILE}.tmp" "$AAR_FILE"
        rm -rf "$EXTRACT_DIR"
    
        echo "Post-strip AAR size: $(ls -lh $AAR_FILE | awk '{print $5}')"

    - name: Upload build artifacts
      if: github.event.inputs.release_tag == ''
      uses: actions/upload-artifact@v6.0.0
      with:
        name: libv2ray
        path: |
          ${{ github.workspace }}/libv2ray*r

    - name: Upload AndroidLibXrayLite to release
      if: github.event.inputs.release_tag != ''
      uses: svenstaro/upload-release-action@v2
      with:
        file: ./libv2ray*r
        tag: ${{ github.event.inputs.release_tag }}
        file_glob: true
        overwrite: true
