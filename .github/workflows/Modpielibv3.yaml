name: Build mod optimise v3

on:
  workflow_dispatch:
    inputs:
      release_tag:
        required: false
        type: string
      merge_prs:
        description: 'Comma-separated PR numbers to merge (e.g., "1,2,3" or "0" for none)'
        required: false
        default: ''
        type: string
        
      fetch_branches_from_other:
        description: 'Enter "username/repo branch" to fetch & merge, or 0 for none'
        required: false
        default: '0'
      merge_dns:
        description: 'merge DNS commit (0 = none)'
        required: false
        default: '0'
        
 
jobs:
  build:
    runs-on: ubuntu-latest
    steps:

    - name: Checkout repository
      uses: actions/checkout@v6.0.0
      
    - uses: actions/cache@v4
      id: go-cache
      with:
       path: |
        .go
         ~/.cache/go-build
         ~/go/pkg/mod
         ~/go/pkg/gomobile
       key: patched-go-${{ hashFiles('go.mod') }}

    - name: Install patched Go
      if: steps.go-cache.outputs.cache-hit != 'true'
      shell: bash
      run: |
       set -e

       # Extract Go version from go.mod
       GO_VERSION=$(sed -n -E 's/^go ([0-9]+\.[0-9]+).*/\1/p' go.mod)
       echo "Go version from go.mod: $GO_VERSION"

        # Get latest full version (e.g., go1.24.2)
       FULL_VERSION=$(curl -s https://go.dev/VERSION?m=text | grep "^go$GO_VERSION")
       echo "Resolved full version: $FULL_VERSION"

       # Download and extract Go locally
       curl -L "https://go.dev/dl/go1.26rc2.linux-amd64.tar.gz" -o go.tar.gz
       tar -xzf go.tar.gz
       mv go .go

       # Define patches
       GO_PATCH_1230="https://github.com/golang/go/commit/76a8409eb81eda553363783dcdd9d6224368ae0e.patch"
       GO_PATCH_1234="https://github.com/golang/go/commit/59b7d40774b29bd1da1aa624f13233111aff4ad2.patch"
       RUNTIME_PATCH="https://raw.githubusercontent.com/Exclude0122/libxivpn/refs/heads/master/goruntime-boottime-over-monotonic.diff"

       # Apply patches
       echo "Applying Go patch 1230..."
       #curl -L "$GO_PATCH_1230" | patch -d .go -p1 --forward

       echo "Applying Go patch 1234..."
       #curl -L "$GO_PATCH_1234" | patch -d .go -p1 --forward

       echo "Applying runtime patch..."
       #curl -L "$RUNTIME_PATCH" -o runtime.patch
       #patch -d .go -p1 --forward < runtime.patch

       # Rebuild Go toolchain (required for runtime patches)
       #echo "Rebuilding Go toolchain..."
       #cd .go/src
       #./make.bash
       #cd ../..

       echo "Patched Go is ready."    

       echo "$(pwd)/.go/bin" >> $GITHUB_PATH
    - name: Activate patched Go
      shell: bash
      run: |
       echo "$(pwd)/.go/bin" >> $GITHUB_PATH
       go version
    - name: Install gomobile
      run: |
        go install golang.org/x/mobile/cmd/gomobile@latest
        echo "$HOME/go/bin" >> $GITHUB_PATH

    - name: Verify 
      run: |
         which go
         which gomobile
        
    - name: Setup Android SDK
      uses: android-actions/setup-android@v3.2.0
      with:
        log-accepted-android-sdk-licenses: false
        cmdline-tools-version: '12266719'
        packages: 'platforms;android-35 build-tools;35.0.0 platform-tools'

    - name: Install NDK
      run: |
        echo "y" | $ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager \
          --channel=0 \
          --install "ndk;28.2.13676358"
        echo "ANDROID_NDK_HOME=$ANDROID_HOME/ndk/28.2.13676358" >> $GITHUB_ENV

    - name: Build
      run: |
        mkdir -p assets data
        bash gen_assets.sh download
        cp -v data/*.dat assets/
        echo "Preparing Go environment..."
        go env -w GOPRIVATE=github.com/xtls/xray-core
        go env -w GONOSUMDB=github.com/xtls/xray-core

        echo "Finding Go module cache path..."
        MODCACHE=$(go env GOMODCACHE)
        echo "Module cache path: $MODCACHE"

        echo "Ensuring xray-core is a full git clone..."
        MOD_PATH="$MODCACHE/github.com/xtls/xray-core"
        rm -rf "$MOD_PATH"  # Remove any proxy-downloaded copy
        XRAY_PATH="$GITHUB_WORKSPACE/_deps/xray-core"
        rm -rf "$XRAY_PATH"
        
        git clone https://github.com/xtls/xray-core.git "$XRAY_PATH"
        cd "$XRAY_PATH"
        git checkout main

        echo "Fetching latest refs from origin..."
        git fetch origin main

        LOCAL_SHA=$(git rev-parse HEAD)
        REMOTE_SHA=$(git rev-parse origin/main)

        echo "Local HEAD:   $LOCAL_SHA"
        echo "Origin/main: $REMOTE_SHA"

        if [ "$LOCAL_SHA" = "$REMOTE_SHA" ]; then
         echo "✅ xray-core is up to date with origin/main"
        else
         echo "⚠️ xray-core is NOT at latest origin/main"
         git log --oneline --decorate --max-count=5 origin/main
        fi
        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"

        if [ "${{ github.event.inputs.merge_dns }}" != "0" ]; then
         DNS_MSG="refactor(dns): streamline query handling and remove redundant deadline logic"

         git remote add j2rong4cn https://github.com/j2rong4cn/Xray-core.git
         git fetch j2rong4cn main

         DNS_HOST_SHA=$(git log j2rong4cn/main --grep="$DNS_MSG" --format="%H" -n 1)

         if [ -n "$DNS_HOST_SHA" ]; then
          echo "Found commit: $DNS_HOST_SHA"
          git cherry-pick "$DNS_HOST_SHA" || true
         else
          echo "$DNS_MSG"
         fi
        fi
       
        
        COUNT=${{ github.event.inputs.pr_count }}
        IFS=',' read -ra PR_LIST <<< "${{ github.event.inputs.merge_prs }}"
          for PR_NUM in "${PR_LIST[@]}"; do
            echo "Fetching PR #$PR_NUM..."
            git fetch origin pull/$PR_NUM/head:pr-$PR_NUM
            echo "Merging PR #$PR_NUM (auto-resolve: theirs)..."
            git merge -X theirs --no-edit pr-$PR_NUM || true
            echo "Changes from PR #$PR_NUM:"
            git log HEAD~1..HEAD --stat || true
          done

        # Merge branch from   repo if requested
        if [ "${{ github.event.inputs.fetch_branches_from_other }}" != "0" ]; then
         BRANCH_INPUT="${{ github.event.inputs.fetch_branches_from_other }}"
        fi
        if [[ "$BRANCH_INPUT" != "0" ]]; then
        IFS=',' read -ra EXT_LIST <<< "$BRANCH_INPUT"
         for ITEM in "${EXT_LIST[@]}"; do
         REPO=$(echo "$ITEM" | awk '{print $1}')
         BRANCH=$(echo "$ITEM" | awk '{print $2}')

        echo "Fetching branch '$BRANCH' from repo '$REPO'..."

        # Name remote based on repo to avoid collision
        REMOTE_NAME="ext_$(echo "$REPO" | sed 's|/|_|g')"

        git remote add "$REMOTE_NAME" "https://github.com/$REPO.git" || true
        git fetch "$REMOTE_NAME" "$BRANCH"

        echo "Merging $REMOTE_NAME/$BRANCH (auto-resolve theirs)..."
        git merge -X theirs --no-edit "$REMOTE_NAME/$BRANCH" || true

        git add -A
        echo "Changes from $REMOTE_NAME/$BRANCH:"
        git log HEAD~1..HEAD --stat || true

        done
        fi          
        
        
        
        
        cd ${{ github.workspace }}/

        echo "Updating go.mod to use local xray-core..."
        go mod edit -replace=github.com/xtls/xray-core="$XRAY_PATH"
        #go mod edit -replace=gvisor.dev/gvisor=gvisor.dev/gvisor@v0.0.0-20260109181451-4be7c433dae2

        #go mod edit -replace=gvisor.dev/gvisor=gvisor.dev/gvisor@v0.0.0-20250606001031-fa4c4dd86b43
          
        # Update specific dependency
        #go get github.com/xtls/xray-core@${{ env.LATEST_TAG_SHA }}

        # Update all other dependencies
        
        
        go mod tidy
        go mod download
       

        
        
        
        echo "Binding for Android..."
        # Export parallel compilation (uses all CPU cores for faster builds)
        export GOMAXPROCS=$(nproc)
        export CGO_ENABLED=1
        export GOEXPERIMENT="runtimefree,sizespecializedmalloc,synchashtriemap,arenas,greenteagc,jsonv2,newinliner,regabi,swissmap,heapminimum512kib"
        echo "Initializing gomobile..."
        gomobile init -v
        go mod tidy


        # Use API 21 compiler (works on Android 5.0+)
        export CC="$ANDROID_NDK_HOME/toolchains/llvm/prebuilt/linux-x86_64/bin/aarch64-linux-android21-clang"
        export CXX="$ANDROID_NDK_HOME/toolchains/llvm/prebuilt/linux-x86_64/bin/aarch64-linux-android21-clang++"


        export CGO_CFLAGS="-O3 -flto=thin -fomit-frame-pointer -fno-semantic-interposition -falign-functions=32"
        export CGO_CXXFLAGS="-O3 -flto=thin -fomit-frame-pointer -fno-semantic-interposition -falign-functions=32"
        #export CGO_LDFLAGS="-O3 -flto=thin -fuse-ld=lld -Wl,-O3 -Wl,--lto-O3 -Wl,--gc-sections -Wl,--icf=all -Wl,--strip-all -WL, -z,max-page-size=16384"
        export CGO_LDFLAGS="-O3 -flto=thin -fuse-ld=lld -Wl,-O3,--lto-O3,--gc-sections,--icf=all,--strip-all,-z,max-page-size=16384"
        #export GOFLAGS="-a"
        gomobile bind \
        -v \
        -androidapi 24 \
        -trimpath \
        -gcflags="all=-l=4" \
        -ldflags="-s -w -buildid='' \
        -checklinkname=0 \
        -linkmode=external -extldflags '-fuse-ld=lld -flto=thin -O3 -Wl,-O3,--lto-O3,--gc-sections,--icf=all,--strip-all,-z,max-page-size=16384'" \
        ./

    - name: Strip native libraries in AAR
      run: |
       # Setup paths
        AAR_FILE="libv2ray.aar"
        EXTRACT_DIR="aar_extract"
        NDK_STRIP="$ANDROID_NDK_HOME/toolchains/llvm/prebuilt/linux-x86_64/bin/llvm-strip"
    
        # Verify AAR exists
       if [ ! -f "$AAR_FILE" ]; then
        echo "Error: $AAR_FILE not found!"
        exit 1
       fi
    
       # Create extraction directory
       mkdir -p "$EXTRACT_DIR"
    
       # Extract AAR (it's just a ZIP)
       echo "Extracting $AAR_FILE..."
       unzip -q "$AAR_FILE" -d "$EXTRACT_DIR"
    
       # Find and strip all .so files
       echo "Stripping native libraries..."
       find "$EXTRACT_DIR" -name "*.so" -type f | while read -r so_file; do
       arch=$(basename "$(dirname "$so_file")")
       echo "  Processing [$arch]: $(basename "$so_file")"
      
       # Get size before
       size_before=$(stat -c%s "$so_file" 2>/dev/null || stat -f%z "$so_file" 2>/dev/null)
      
       # Strip: --strip-all removes all symbols (same as -s)
       "$NDK_STRIP" --strip-all "$so_file"
      
       # Get size after
       size_after=$(stat -c%s "$so_file" 2>/dev/null || stat -f%z "$so_file" 2>/dev/null)
       saved=$((size_before - size_after))
      
       echo "    Saved: $saved bytes ($(numfmt --to=iec $saved 2>/dev/null || echo "$saved"))"
       done
    
       # Repackage AAR with maximum compression
       echo "Repackaging AAR..."
       cd "$EXTRACT_DIR"
     
       # Create new AAR with optimized compression
       # -X: no extra file attributes (cleaner)
       # -9: maximum compression
       zip -r -X -9 "../${AAR_FILE}.tmp" .
       cd ..
    
       # Replace original
       mv "${AAR_FILE}.tmp" "$AAR_FILE"
    
       # Cleanup
       rm -rf "$EXTRACT_DIR"
    
       # Show final result
       echo "Post-strip AAR size: $(ls -lh $AAR_FILE | awk '{print $5}')"


    - name: Upload build artifacts
      if: github.event.inputs.release_tag == ''
      uses: actions/upload-artifact@v6.0.0
      with:
        name: libv2ray
        path: |
          ${{ github.workspace }}/libv2ray*r

    - name: Upload AndroidLibXrayLite to release
      if: github.event.inputs.release_tag != ''
      uses: svenstaro/upload-release-action@v2
      with:
        file: ./libv2ray*r
        tag: ${{ github.event.inputs.release_tag }}
        file_glob: true
        overwrite: true
